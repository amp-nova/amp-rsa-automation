#parse( "../../../master/globals.vm" )
#parse( "../../../master/macros.vm" )

# some entities (such as vse) are hub specific, this variable is used as a common prefix in the name of these entities
#set( $hub = "{{cms.hubName}}" )
#set( $hubLabel = "{{cms.hubLabel}}" )
#set( $bucketId = "<TBD>" )
#set( $securityGroup = "Dynamic Content" )

# To use media, you must already have an asset store created
buckets:
  - label: Assets

# API client key / secret used for media publishing
clients:
  - label: dc-media-publishing-client-$hub
    confidential: true

---
#parse( "../../../master/functional.vm" )
---

groups:
  - label: Dynamic Content-Publishing-$hub
#    permissions:
#      - DAM:BUCKET:ID_HERE:READ
    members:
      - client: <%= clients/dc-media-publishing-client-$hub/id %>
  - label: Dynamic Content-Amplience-Admin
#   members:
#      - email: user@example.com
  - label: Dynamic Content-Amplience-CS
  - label: Dynamic Content-Customer-Admin
    members:
      {{#each cms.internalAcl}}
      - email: {{this}}+{{../cms.hubName}}@amplience.com 
      {{/each}}
      {{#each cms.externalAcl}}
      - email: {{this}}
      {{/each}}
  - label: Dynamic Content-Developer
  - label: Dynamic Content-Planner
  - label: Dynamic Content-Producer
  - label: Dynamic Content-Read-Only

# Create the whitelist in VSE app instead, unless using Staging or UAT
# Make sure the whitelist name matches the $securityGroup at the top of this yaml 
security-groups:
  - label: Dynamic Content
      ranges:
        {{#each cms.whiteList}}
        - label: {{this.label}}
          cidr: {{this.cidr}}
        {{/each}}
hub:
  name: $hub
  label: $hubLabel
  settings:
    publishing:
      platforms:
        amplience_dam:
          API_KEY: <%= clients/dc-media-publishing-client-$hub/id %>
          API_SECRET: <%= clients/dc-media-publishing-client-$hub/secret %>
          endpoint: <%= endpoint/tag %>
  acl:
    {{#each cms.referenceAcl}}
    - #hubAmplienceById(${{this}}) 
    {{/each}}
    {{#each cms.internalAcl}}
    - #hubAdmin("{{this}}+{{../cms.hubName}}@amplience.com")
    {{/each}}
    {{#each cms.externalAcl}}
    - #hubAdmin("{{this}}")
    {{/each}}

virtual-staging-environments:
  - label: $hub
    security-group: $securityGroup
    enabled: true
    rules:
      - rule_type: hub_content
        hub_id: <%= hub/id %>
      - rule_type: bucket_content
        bucket_id: $bucketId
      - rule_type: published_content
        tag: <%= endpoint/tag %>

content-repositories:
  {{#each cms.repositories}}
  - name: {{this.name}}
    label: {{this.label}}
    {{#if this.features}}
    features:
    {{#each this.features}}
      - {{this}}
    {{/each}}
    {{/if}}
    acl:
      {{#each ../cms.referenceAcl}}
      - #repoAmplienceById(${{this}})
      {{/each}}
      {{#each ../cms.internalAcl}}
      - #repoEdit("{{this}}+{{../../cms.hubName}}@amplience.com")
      {{/each}} 
      {{#each ../cms.externalAcl}}
      - #repoEdit("{{this}}")
      {{/each}}

  {{/each}}
hub-settings:
  virtualStagingEnvironment:
    hostname: <%= virtual-staging-environments/$hub/domain %>
  previewVirtualStagingEnvironment:
    hostname: <%= virtual-staging-environments/$hub/domain %>